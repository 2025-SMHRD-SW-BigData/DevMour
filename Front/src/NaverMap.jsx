import React, { useEffect, useState, useRef, useContext } from "react";
import { InfoContext } from "./context/InfoContext";
import axios from 'axios';

const NaverMap = ({ onMarkerClick }) => {
    const mapRef = useRef(null);
    const [isEditing, setIsEditing] = useState(false);
    const isEditingRef = useRef(isEditing);
    const [selectedMarkerType, setSelectedMarkerType] = useState('cctv');
    const selectedMarkerTypeRef = useRef(selectedMarkerType);
    const [markers, setMarkers] = useState([]);
    const markersRef = useRef([]);
    const [filterType, setFilterType] = useState('all');
    const [alertMarker, setAlertMarker] = useState(null);
    const alertMarkerRef = useRef(null);

    const { lat, setLat, lon, setLon } = useContext(InfoContext);

    const latRef = useRef(lat);
    const lonRef = useRef(lon);

    useEffect(() => {
        latRef.current = lat;
        lonRef.current = lon;
    }, [lat, lon]);

    useEffect(() => {
        isEditingRef.current = isEditing;
    }, [isEditing]);

    useEffect(() => {
        selectedMarkerTypeRef.current = selectedMarkerType;
    }, [selectedMarkerType]);

    const markerTypes = {
        cctv: {
            name: 'CCTV',
            color: '#FF4444',
            icon: 'üìπ',
            size: { width: 30, height: 30 }
        },
        construction: {
            name: 'Í≥µÏÇ¨Ï§ë',
            color: '#FF8800',
            icon: 'üöß',
            size: { width: 30, height: 30 }
        },
        flood: {
            name: 'Ïπ®Ïàò',
            color: '#4488FF',
            icon: 'üåä',
            size: { width: 30, height: 30 }
        }
    };

    const createMarkerContent = (type) => {
        const config = markerTypes[type];
        return `
      <div style="
        background-color: ${config.color};
        border-radius: 50%;
        width: ${config.size.width}px;
        height: ${config.size.height}px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        cursor: pointer;
      ">
        ${config.icon}
      </div>
    `;
    };

    // ‚úÖ ÏàòÏ†ïÎêú addMarker Ìï®Ïàò
    const addMarker = async (lat, lng, type) => {
        if (!mapRef.current) return;

        try {
            const response = await axios.post('http://localhost:3001/api/marker/updatemarker', {
                lat: lat,
                lon: lng,
                marker_type: type
            });

            console.log('‚úÖ ÏÑúÎ≤Ñ ÌÜµÏã† ÏÑ±Í≥µ:', response.data);

            // ÏÑúÎ≤Ñ ÏùëÎãµÏóêÏÑú marker_id Ï∂îÏ∂ú (Ïã§Ï†ú DBÏóê Ï†ÄÏû•Îêú ID)
            const serverMarkerId = response.data.marker_id || response.data.id || Date.now();

            const newMarkerData = {
                id: serverMarkerId,
                marker_id: serverMarkerId, // ‚úÖ ModalsÏóêÏÑú ÏÇ¨Ïö©Ìï† marker_id
                lat,
                lng,
                type,
                name: markerTypes[type].name,
                icon: markerTypes[type].icon,
                color: markerTypes[type].color
            };

            const naverMarker = new window.naver.maps.Marker({
                position: new window.naver.maps.LatLng(lat, lng),
                map: mapRef.current,
                icon: {
                    content: createMarkerContent(type),
                    anchor: new window.naver.maps.Point(15, 15)
                }
            });

            // ‚úÖ ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º Ï¶âÏãú Îì±Î°ù
            window.naver.maps.Event.addListener(naverMarker, 'click', () => {
                console.log("ÎßàÏª§ÌÅ¥Î¶≠:", type, "marker_id:", serverMarkerId);
                
                // ‚úÖ InfoContextÏùò lat, lon Í∞í ÏóÖÎç∞Ïù¥Ìä∏
                setLat(lat);
                setLon(lng);
                
                if (onMarkerClick) {
                    onMarkerClick(type, newMarkerData);
                }
            });

            // ‚úÖ Ìïú Î≤àÎßå Ï∂îÍ∞ÄÌïòÍ≥† ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
            setMarkers(prev => [...prev, newMarkerData]);
            markersRef.current.push(naverMarker);

            console.log(`üìç ÎßàÏª§Í∞Ä ÏßÄÎèÑÏóê Ï∂îÍ∞ÄÎê®: ${type} at ${lat}, ${lng} (ID: ${serverMarkerId})`);

        } catch (error) {
            console.error('‚ùå ÎßàÏª§ Ï∂îÍ∞Ä Ïã§Ìå®:', error.response ? error.response.data : error.message);
        }
    };

    // ‚úÖ ÏàòÏ†ïÎêú removeMarker Ìï®Ïàò
    const removeMarker = (markerId) => {
        const markerIndex = markers.findIndex(m => m.id === markerId);
        if (markerIndex !== -1 && markerIndex < markersRef.current.length) {
            if (markersRef.current[markerIndex]) {
                markersRef.current[markerIndex].setMap(null);
                markersRef.current.splice(markerIndex, 1);
            }
            setMarkers(prev => prev.filter(marker => marker.id !== markerId));
        }
    };

    const clearAllMarkers = () => {
        markersRef.current.forEach(marker => {
            if (marker && marker.setMap) {
                marker.setMap(null);
            }
        });
        markersRef.current = [];
        setMarkers([]);
    };

    // ÏïåÎ¶º ÌÅ¥Î¶≠ Ïãú ÏßÄÎèÑ Ïù¥Îèô Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
    const handleMoveToLocation = (event) => {
        const { lat, lon, message, level } = event.detail;
        console.log('üéØ ÏßÄÎèÑ Ïù¥Îèô Ïù¥Î≤§Ìä∏ ÏàòÏã†:', lat, lon, message, level);
        
        if (mapRef.current) {
            const newPosition = new window.naver.maps.LatLng(lat, lon);
            mapRef.current.setCenter(newPosition);
            mapRef.current.setZoom(15); // Ï§å Î†àÎ≤®ÏùÑ 15Î°ú ÏÑ§Ï†ïÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞
            
            // Í∏∞Ï°¥ ÏïåÎ¶º ÎßàÏª§ Ï†úÍ±∞
            removeAlertMarker();
            
            // ÏÉàÎ°úÏö¥ ÏïåÎ¶º ÎßàÏª§ ÏÉùÏÑ±
            createAlertMarker(lat, lon, message, level);
            
            console.log('‚úÖ ÏßÄÎèÑ Ïù¥Îèô Î∞è ÏïåÎ¶º ÎßàÏª§ ÏÉùÏÑ± ÏôÑÎ£å:', lat, lon);
        } else {
            console.warn('‚ö†Ô∏è ÏßÄÎèÑ Í∞ùÏ≤¥Í∞Ä ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }
    };

    // ÏúÑÌóòÎèÑ Îû≠ÌÇπ ÌÅ¥Î¶≠ Ïãú ÏßÄÎèÑ Ïù¥Îèô Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
    const handleMoveToRiskLocation = (event) => {
        const { lat, lon, message, level, riskDetail, totalRiskScore } = event.detail;
        console.log('üéØ ÏúÑÌóòÎèÑ ÏúÑÏπò Ïù¥Îèô Ïù¥Î≤§Ìä∏ ÏàòÏã†:', lat, lon, message, level);
        
        if (mapRef.current) {
            const newPosition = new window.naver.maps.LatLng(lat, lon);
            mapRef.current.setCenter(newPosition);
            mapRef.current.setZoom(15); // Ï§å Î†àÎ≤®ÏùÑ 15Î°ú ÏÑ§Ï†ïÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞
            
            // Í∏∞Ï°¥ ÏïåÎ¶º ÎßàÏª§ Ï†úÍ±∞
            removeAlertMarker();
            
            // ÏÉàÎ°úÏö¥ ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏÉùÏÑ±
            createRiskInfoMarker(lat, lon, message, level, riskDetail, totalRiskScore);
            
            console.log('‚úÖ ÏúÑÌóòÎèÑ ÏúÑÏπò Ïù¥Îèô Î∞è Ï†ïÎ≥¥ ÎßàÏª§ ÏÉùÏÑ± ÏôÑÎ£å:', lat, lon);
        } else {
            console.warn('‚ö†Ô∏è ÏßÄÎèÑ Í∞ùÏ≤¥Í∞Ä ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }
    };

    // ÏïåÎ¶º ÎßàÏª§ ÏÉùÏÑ± Ìï®Ïàò
    const createAlertMarker = (lat, lon, message, level) => {
        if (!mapRef.current) return;

        // ÏïåÎ¶º ÎßàÏª§ HTML ÏÉùÏÑ±
        const alertMarkerContent = `
            <div style="
                background: linear-gradient(135deg, ${getAlertMarkerColor(level)});
                border-radius: 8px;
                padding: 8px 12px;
                color: white;
                font-size: 12px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                border: 2px solid white;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-align: center;
                position: relative;
                margin-bottom: 15px;
            ">
                <div style="margin-bottom: 4px;">${getAlertIcon(level)}</div>
                <div style="font-size: 10px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${message}</div>
                <div style="
                    position: absolute;
                    bottom: -8px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 8px solid transparent;
                    border-right: 8px solid transparent;
                    border-top: 8px solid ${getAlertMarkerColor(level)};
                "></div>
            </div>
            <div style="
                width: 20px;
                height: 20px;
                background: ${getAlertMarkerColor(level).split(',')[0]};
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                position: relative;
                margin: 0 auto;
            ">
                <div style="
                    position: absolute;
                    bottom: -15px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 8px solid transparent;
                    border-right: 8px solid transparent;
                    border-top: 15px solid ${getAlertMarkerColor(level).split(',')[0]};
                "></div>
            </div>
            <style>
                @keyframes pulse {
                    0% {
                        transform: scale(1);
                        opacity: 1;
                    }
                    50% {
                        transform: scale(1.1);
                        opacity: 0.8;
                    }
                    100% {
                        transform: scale(1);
                        opacity: 1;
                    }
                }
            </style>
        `;

        // ÏïåÎ¶º ÎßàÏª§ ÏÉùÏÑ±
        const newAlertMarker = new window.naver.maps.Marker({
            position: new window.naver.maps.LatLng(lat, lon),
            map: mapRef.current,
            icon: {
                content: alertMarkerContent,
                anchor: new window.naver.maps.Point(100, 35) // ÎßàÏª§ Ï§ëÏïô ÌïòÎã®Ïóê ÏúÑÏπò (ÏïµÏª§ ÎßàÏª§ Í≥†Î†§)
            }
        });

        // ÏïåÎ¶º ÎßàÏª§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setAlertMarker(newAlertMarker);
        alertMarkerRef.current = newAlertMarker;

        // 10Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú ÏïåÎ¶º ÎßàÏª§ Ï†úÍ±∞
        setTimeout(() => {
            if (alertMarkerRef.current === newAlertMarker) {
                removeAlertMarker();
                console.log('‚è∞ ÏïåÎ¶º ÎßàÏª§ ÏûêÎèô Ï†úÍ±∞ ÏôÑÎ£å');
            }
        }, 10000);

        console.log('‚úÖ ÏïåÎ¶º ÎßàÏª§ ÏÉùÏÑ± ÏôÑÎ£å:', message);
    };

    // ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏÉùÏÑ± Ìï®Ïàò
    const createRiskInfoMarker = (lat, lon, message, level, riskDetail, totalRiskScore) => {
        if (!mapRef.current) return;

        // ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ HTML ÏÉùÏÑ±
        const riskMarkerContent = `
            <div style="
                background: linear-gradient(135deg, ${getAlertMarkerColor(level)});
                border-radius: 8px;
                padding: 12px 16px;
                color: white;
                font-size: 12px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                border: 2px solid white;
                max-width: 250px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-align: center;
                position: relative;
                margin-bottom: 15px;
            ">
                <div style="margin-bottom: 6px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üö® ÏúÑÌóòÎèÑ Ï†ïÎ≥¥</div>
                <div style="margin-bottom: 4px; font-size: 11px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${message}</div>
                <div style="
                    margin-top: 8px;
                    padding: 6px 8px;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 4px;
                    font-size: 10px;
                    line-height: 1.3;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                ">${riskDetail}</div>
                <div style="
                    position: absolute;
                    bottom: -8px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 8px solid transparent;
                    border-right: 8px solid transparent;
                    border-top: 8px solid ${getAlertMarkerColor(level)};
                "></div>
            </div>
            <div style="
                width: 20px;
                height: 20px;
                background: ${getAlertMarkerColor(level).split(',')[0]};
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                position: relative;
                margin: 0 auto;
                animation: pulse 2s infinite;
            ">
                <div style="
                    position: absolute;
                    bottom: -15px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 8px solid transparent;
                    border-right: 8px solid transparent;
                    border-top: 15px solid ${getAlertMarkerColor(level).split(',')[0]};
                "></div>
            </div>
        `;

        // ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏÉùÏÑ±
        const newRiskMarker = new window.naver.maps.Marker({
            position: new window.naver.maps.LatLng(lat, lon),
            map: mapRef.current,
            icon: {
                content: riskMarkerContent,
                anchor: new window.naver.maps.Point(125, 40) // ÎßàÏª§ Ï§ëÏïô ÌïòÎã®Ïóê ÏúÑÏπò
            }
        });

        // ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setAlertMarker(newRiskMarker);
        alertMarkerRef.current = newRiskMarker;

        // 15Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ Ï†úÍ±∞
        setTimeout(() => {
            if (alertMarkerRef.current === newRiskMarker) {
                removeAlertMarker();
                console.log('‚è∞ ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏûêÎèô Ï†úÍ±∞ ÏôÑÎ£å');
            }
        }, 15000);

        console.log('‚úÖ ÏúÑÌóòÎèÑ Ï†ïÎ≥¥ ÎßàÏª§ ÏÉùÏÑ± ÏôÑÎ£å:', message);
    };

    // ÏïåÎ¶º ÎßàÏª§ Ï†úÍ±∞ Ìï®Ïàò
    const removeAlertMarker = () => {
        if (alertMarkerRef.current) {
            alertMarkerRef.current.setMap(null);
            alertMarkerRef.current = null;
        }
        setAlertMarker(null);
        console.log('‚úÖ ÏïåÎ¶º ÎßàÏª§ Ï†úÍ±∞ ÏôÑÎ£å');
    };

    // ÏïåÎ¶º Î†àÎ≤®Ïóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞òÌôò
    const getAlertMarkerColor = (level) => {
        switch (level) {
            case 'Îß§Ïö∞ ÏúÑÌóò':
                return '#ff6b6b, #ee5a24';
            case 'ÏúÑÌóò':
                return '#ff9f43, #f39c12';
            case 'Í≤ΩÍ≥†':
                return '#feca57, #ff9ff3';
            case 'ÏïàÏ†Ñ':
                return '#2ecc71, #27ae60';
            default:
                return '#feca57, #ff9ff3';
        }
    };

    // ÏïµÏª§ ÎßàÏª§ ÏÉâÏÉÅ Î∞òÌôò (Îã®Ïùº ÏÉâÏÉÅ)
    const getAnchorMarkerColor = (level) => {
        switch (level) {
            case 'Îß§Ïö∞ ÏúÑÌóò':
                return '#e74c3c';
            case 'ÏúÑÌóò':
                return '#e67e22';
            case 'Í≤ΩÍ≥†':
                return '#f39c12';
            case 'ÏïàÏ†Ñ':
                return '#27ae60';
            default:
                return '#f39c12';
        }
    };

    // ÏïåÎ¶º Î†àÎ≤®Ïóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò Î∞òÌôò
    const getAlertIcon = (level) => {
        switch (level) {
            case 'Îß§Ïö∞ ÏúÑÌóò':
                return 'üö®';
            case 'ÏúÑÌóò':
                return '‚ö†Ô∏è';
            case 'Í≤ΩÍ≥†':
                return '‚ö†Ô∏è';
            case 'ÏïàÏ†Ñ':
                return '‚úÖ';
            default:
                return '‚ö†Ô∏è';
        }
    };

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù Ìï®Ïàò
    const setupEventListeners = () => {
        // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
        window.removeEventListener('moveToLocation', handleMoveToLocation);
        window.removeEventListener('moveToRiskLocation', handleMoveToRiskLocation);
        // ÏÉàÎ°úÏö¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        window.addEventListener('moveToLocation', handleMoveToLocation);
        window.addEventListener('moveToRiskLocation', handleMoveToRiskLocation);
        console.log('‚úÖ ÏßÄÎèÑ Ïù¥Îèô Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å');
    };

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨ Ìï®Ïàò
    const cleanupEventListeners = () => {
        window.removeEventListener('moveToLocation', handleMoveToLocation);
        window.removeEventListener('moveToRiskLocation', handleMoveToRiskLocation);
        console.log('‚úÖ ÏßÄÎèÑ Ïù¥Îèô Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨ ÏôÑÎ£å');
    };

    useEffect(() => {
        const script = document.createElement("script");
        const newClientId = "se9uk5m3m9";
        script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${newClientId}&submodules=geocoder`;
        script.async = true;

        script.onload = () => {
            const mapOptions = {
                center: new window.naver.maps.LatLng(35.146667, 126.888667),
                zoom: 13,
                mapTypeControl: true,
                maxBounds: new window.naver.maps.LatLngBounds(
                    new window.naver.maps.LatLng(35.0, 126.6),
                    new window.naver.maps.LatLng(35.2, 127.0)
                ),
                minZoom: 11
            };

            const map = new window.naver.maps.Map('naverMap', mapOptions);
            mapRef.current = map;

            fetchMarkers(map);

            window.naver.maps.Event.addListener(map, 'click', (e) => {
                console.log('ÏßÄÎèÑ ÌÅ¥Î¶≠Îê®:', e.coord.y, e.coord.x, 'Ìé∏ÏßëÎ™®Îìú:', isEditingRef.current);

                setLat(e.coord.y);
                setLon(e.coord.x);

                if (isEditingRef.current) {
                    addMarker(e.coord.y, e.coord.x, selectedMarkerTypeRef.current);
                }
            });

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            setupEventListeners();

            console.log('ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        };

        script.onerror = () => {
            console.error('ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®');
        };

        document.head.appendChild(script);

        return () => {
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            cleanupEventListeners();
        };
    }, []);

    // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
    useEffect(() => {
        return () => {
            cleanupEventListeners();
            removeAlertMarker();
        };
    }, []);

    // ‚úÖ ÏàòÏ†ïÎêú fetchMarkers Ìï®Ïàò
    const fetchMarkers = async (map) => {
        try {
            const response = await axios.get('http://localhost:3001/api/marker/allmarkers');
            const markerDataList = response.data;
            
            // ‚úÖ Î∞∞Ïó¥Îì§ÏùÑ Ï¥àÍ∏∞Ìôî
            const newMarkers = [];
            const newNaverMarkers = [];

            console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú ÎßàÏª§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', markerDataList);

            markerDataList.forEach(markerData => {
                const lat = parseFloat(markerData.lat);
                const lon = parseFloat(markerData.lon);
                const { marker_type, marker_id } = markerData;

                if (isNaN(lat) || isNaN(lon) || !markerTypes[marker_type]) {
                    console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎßàÏª§ Îç∞Ïù¥ÌÑ∞:', markerData);
                    return;
                }

                const newMarkerData = {
                    id: marker_id, // ‚úÖ DBÏùò marker_id ÏÇ¨Ïö©
                    marker_id: marker_id, // ‚úÖ ModalsÏóêÏÑú ÏÇ¨Ïö©Ìï† marker_id Ï∂îÍ∞Ä
                    lat,
                    lng: lon,
                    type: marker_type,
                    name: markerTypes[marker_type].name,
                    icon: markerTypes[marker_type].icon,
                    color: markerTypes[marker_type].color
                };

                const naverMarker = new window.naver.maps.Marker({
                    position: new window.naver.maps.LatLng(lat, lon),
                    map: map,
                    icon: {
                        content: createMarkerContent(marker_type),
                        anchor: new window.naver.maps.Point(15, 15)
                    }
                });

                // ‚úÖ ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º Ï¶âÏãú Îì±Î°ù
                window.naver.maps.Event.addListener(naverMarker, 'click', () => {
                    console.log("ÎßàÏª§ÌÅ¥Î¶≠:", marker_type, "marker_id:", marker_id);
                    
                    // ‚úÖ InfoContextÏùò lat, lon Í∞í ÏóÖÎç∞Ïù¥Ìä∏
                    setLat(lat);
                    setLon(lon);
                    
                    if (onMarkerClick) {
                        onMarkerClick(marker_type, newMarkerData);
                    }
                });

                newMarkers.push(newMarkerData);
                newNaverMarkers.push(naverMarker);
            });

            // ‚úÖ ÏÉÅÌÉúÎ•º Ìïú Î≤àÏóê ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏó¨ ÎèôÍ∏∞Ìôî Î≥¥Ïû•
            setMarkers(newMarkers);
            markersRef.current = newNaverMarkers;

            console.log(`ÏßÄÎèÑÏóê Ï¥ù ${markerDataList.length}Í∞úÏùò ÎßàÏª§Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`);

        } catch (error) {
            console.error('‚ùå ÎßàÏª§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error.response ? error.response.data : error.message);
        }
    };

    // ‚úÖ ÏàòÏ†ïÎêú ÎßàÏª§ ÌïÑÌÑ∞ÎßÅ useEffect
    useEffect(() => {
        if (!mapRef.current || markersRef.current.length === 0 || markers.length === 0) return;

        // ‚úÖ Î∞∞Ïó¥ Í∏∏Ïù¥ Ï≤¥ÌÅ¨ Î∞è ÏïàÏ†ÑÌïú Ï†ëÍ∑º
        const minLength = Math.min(markersRef.current.length, markers.length);
        
        for (let i = 0; i < minLength; i++) {
            const naverMarker = markersRef.current[i];
            const markerData = markers[i];
            
            // ‚úÖ null Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä
            if (!naverMarker || !markerData) {
                console.warn(`ÎßàÏª§ Îç∞Ïù¥ÌÑ∞ Î∂àÏùºÏπò Í∞êÏßÄ: index ${i}`);
                continue;
            }

            if (filterType === 'all' || markerData.type === filterType) {
                naverMarker.setMap(mapRef.current);
            } else {
                naverMarker.setMap(null);
            }
        }

    }, [filterType, markers]);

    const filteredMarkers = filterType === 'all'
        ? markers
        : markers.filter(marker => marker.type === filterType);

    const handleToggleEditing = () => {
        setIsEditing(prev => {
            console.log('Ìé∏Ïßë Î™®Îìú Î≥ÄÍ≤Ω:', !prev);
            return !prev;
        });
    };

    return (
        <div style={{ position: 'relative', width: '100%', height: '100%' }}>
            <div
                id="naverMap"
                style={{ width: "100%", height: "100%", borderRadius: "10px" }}
            ></div>

            <button
                onClick={handleToggleEditing}
                style={{
                    position: 'absolute',
                    top: '10px',
                    right: '10px',
                    zIndex: 100,
                    padding: '10px 15px',
                    backgroundColor: isEditing ? '#FF0000' : '#4CAF50',
                    color: 'white',
                    border: 'none',
                    borderRadius: '5px',
                    cursor: 'pointer',
                    fontWeight: 'bold'
                }}>
                {isEditing ? 'Ìé∏Ïßë ÏôÑÎ£å' : 'Ìé∏Ïßë Î™®Îìú'}
            </button>

            <div style={{
                position: 'absolute',
                top: '10px',
                left: '10px',
                zIndex: 100,
                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                color: 'white',
                padding: '10px',
                borderRadius: '8px',
                display: 'flex',
                gap: '10px',
            }}>
                <button
                    onClick={() => setFilterType('all')}
                    style={{
                        backgroundColor: filterType === 'all' ? '#2196F3' : 'transparent',
                        color: 'white',
                        border: '1px solid white',
                        borderRadius: '5px',
                        padding: '8px 12px',
                        cursor: 'pointer',
                        fontWeight: 'bold'
                    }}
                >
                    Î™®Îëê Î≥¥Í∏∞
                </button>
                {Object.entries(markerTypes).map(([type, config]) => (
                    <button
                        key={type}
                        onClick={() => setFilterType(type)}
                        style={{
                            backgroundColor: filterType === type ? config.color : 'transparent',
                            color: 'white',
                            border: `1px solid ${filterType === type ? config.color : 'white'}`,
                            borderRadius: '5px',
                            padding: '8px 12px',
                            cursor: 'pointer',
                            fontWeight: 'bold'
                        }}
                    >
                        {config.icon} {config.name}
                    </button>
                ))}
            </div>

            {isEditing && (
                <div style={{
                    position: 'absolute',
                    top: '60px',
                    right: '10px',
                    zIndex: 100,
                    backgroundColor: 'white',
                    padding: '15px',
                    borderRadius: '8px',
                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
                    border: '1px solid #ddd'
                }}>
                    <h4 style={{ margin: '0 0 10px 0', fontSize: '14px', fontWeight: 'bold' }}>ÎßàÏª§ ÏÑ†ÌÉù</h4>
                    {Object.entries(markerTypes).map(([type, config]) => (
                        <div key={type} style={{ marginBottom: '8px' }}>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                cursor: 'pointer',
                                fontSize: '13px'
                            }}>
                                <input
                                    type="radio"
                                    name="markerType"
                                    value={type}
                                    checked={selectedMarkerType === type}
                                    onChange={(e) => {
                                        console.log('ÎßàÏª§ ÌÉÄÏûÖ Î≥ÄÍ≤Ω:', e.target.value);
                                        setSelectedMarkerType(e.target.value);
                                    }}
                                    style={{ marginRight: '8px' }}
                                />
                                <span style={{ marginRight: '5px', fontSize: '16px' }}>{config.icon}</span>
                                {config.name}
                            </label>
                        </div>
                    ))}
                    <button
                        onClick={clearAllMarkers}
                        style={{
                            width: '100%',
                            marginTop: '10px',
                            padding: '8px',
                            backgroundColor: '#ff4444',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            fontSize: '12px',
                            cursor: 'pointer'
                        }}
                    >
                        Î™®Îì† ÎßàÏª§ ÏÇ≠Ï†ú
                    </button>
                </div>
            )}

            {isEditing && filteredMarkers.length > 0 && (
                <div style={{
                    position: 'absolute',
                    bottom: '10px',
                    left: '10px',
                    zIndex: 100,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    color: 'white',
                    padding: '15px',
                    borderRadius: '8px',
                    fontSize: '12px',
                    maxHeight: '200px',
                    overflowY: 'auto',
                    minWidth: '250px'
                }}>
                    <h4 style={{ margin: '0 0 10px 0' }}>Ï∂îÍ∞ÄÎêú ÎßàÏª§ ({filteredMarkers.length}Í∞ú)</h4>
                    {filteredMarkers.map((marker, index) => (
                        <div key={marker.id} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '8px',
                            padding: '5px',
                            backgroundColor: 'rgba(255,255,255,0.1)',
                            borderRadius: '4px'
                        }}>
                            <div>
                                <span style={{ marginRight: '5px' }}>{markerTypes[marker.type].icon}</span>
                                <span>{marker.name}</span>
                                <br />
                                <small style={{ color: '#ccc' }}>
                                    {marker.lat.toFixed(6)}, {marker.lng.toFixed(6)}
                                </small>
                            </div>
                            <button
                                onClick={() => removeMarker(marker.id)}
                                style={{
                                    backgroundColor: '#ff4444',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '3px',
                                    padding: '2px 6px',
                                    fontSize: '10px',
                                    cursor: 'pointer'
                                }}
                            >
                                ÏÇ≠Ï†ú
                            </button>
                        </div>
                    ))}
                </div>
            )}

            {isEditing && markers.length === 0 && (
                <div style={{
                    position: 'absolute',
                    bottom: '10px',
                    left: '10px',
                    zIndex: 100,
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    color: 'white',
                    padding: '10px',
                    borderRadius: '5px',
                    fontSize: '12px'
                }}>
                    <p>üìç ÏßÄÎèÑÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÎßàÏª§Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
                    <p>ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎßàÏª§: {markerTypes[selectedMarkerType].icon} {markerTypes[selectedMarkerType].name}</p>
                    <p>Ìé∏ÏßëÎ™®Îìú ÏÉÅÌÉú: {isEditingRef.current ? 'ON' : 'OFF'}</p>
                </div>
            )}

            <div style={{
                position: 'absolute',
                top: '10px',
                left: '10px',
                zIndex: 100,
                backgroundColor: 'rgba(0,0,0,0.5)',
                color: 'white',
                padding: '5px 10px',
                borderRadius: '4px',
                fontSize: '11px'
            }}>
                Ìé∏ÏßëÎ™®Îìú: {isEditing ? 'ON' : 'OFF'} | ÎßàÏª§: {markers.length}Í∞ú
            </div>
        </div>
    );
};

export default React.memo(NaverMap, (prevProps, nextProps) => {
    return prevProps.onMarkerClick === nextProps.onMarkerClick;
});